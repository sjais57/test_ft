import json

# path to your manifest
manifest_path = "platform.json"

with open(manifest_path, "r") as f:
    manifest = json.load(f)

project_id = manifest.get("project_id", "unknown")
apisix_modules = manifest.get("modules", [])

print(f"Project ID: {project_id}")
print(f"Found {len(apisix_modules)} modules")


global_plugins = {}

for apisix_module in apisix_modules:
    config = apisix_module.get("config", {})
    for plugin in config.get("global_plugins", []):
        if plugin.get("enabled", True):
            global_plugins[plugin["name"]] = plugin.get("config", {})

print("=== Extracted Global Plugins ===")


global_plugins = {}
for apisix_module in apisix_modules:
    config = apisix_module.get("config", {})
    for plugin in config.get("global_plugins", []):
        if plugin.get("enabled", True):
            global_plugins[plugin["name"]] = plugin.get("config", {})


print(f"[DEBUG] Found global plugins for {project_id}: {list(global_plugins.keys())}")



if project_id == "platform" and global_plugins:
    global_rule_id = "platform-global-plugins"
    print(f"[INFO] Setting global rule {global_rule_id} with plugins: {list(global_plugins.keys())}")
    result = await self.global_rules_manager.set_global_rule(global_rule_id, global_plugins)
    results["global_rules"].append(result)
else:
    print(f"[INFO] Skipping global plugin setup for project {project_id}")

print(json.dumps(global_plugins, indent=2))
