{
  "project_id": "platform",
  "project_name": "APISIX Platform Global Configuration",
  "owner": "DSP Core Team",
  "environment": "production",
  "manifest_version": "1.0",
  "modules": [
    {
      "module_type": "api_gateway",
      "name": "platform-global-plugins",
      "description": "Global APISIX plugins for JWT transformation, logging, and CORS",
      "config": {
        "global_plugins": [
          {
            "name": "serverless-pre-function",
            "enabled": true,
            "config": {
              "phase": "access",
              "functions": [
                "return function(conf, ctx)\n  local core = require('apisix.core');\n  local jwt = require('resty.jwt');\n  local auth_header = ngx.var.http_authorization;\n  if not auth_header then core.log.warn('Missing Authorization header'); return; end;\n  local encoded_jwt = string.match(auth_header, 'Bearer%s+(.+)');\n  if not encoded_jwt then core.log.warn('Authorization header does not contain Bearer token'); return; end;\n  local jwt_obj = jwt:load_jwt(encoded_jwt);\n  if not (jwt_obj and jwt_obj.valid) then core.log.warn('Invalid JWT'); return; end;\n  local upstream_token = jwt_obj.payload['ahpc_auth_token'];\n  if upstream_token then ngx.req.set_header('Authorization', 'Bearer ' .. upstream_token); core.log.info('Set new Authorization header from ahpc_auth_token claim'); else core.log.warn('ahpc_auth_token claim missing in JWT payload'); end;\nend"
              ]
            }
          },
          {
            "name": "serverless-post-function",
            "enabled": true,
            "config": {
              "phase": "log",
              "functions": [
                "return function(conf, ctx)\n  local core = require('apisix.core');\n  core.log.info('Request processed for ', ngx.var.request_uri, ' with status ', ngx.status);\nend"
              ]
            }
          },
          {
            "name": "cors",
            "enabled": true,
            "config": {
              "allow_origins": "*",
              "allow_methods": "*",
              "allow_headers": "*",
              "expose_headers": "*",
              "max_age": 3600,
              "allow_credential": true
            }
          },
          {
            "name": "prometheus",
            "enabled": true,
            "config": {
              "prefer_name": true
            }
          },
          {
            "name": "request-id",
            "enabled": true,
            "config": {
              "header_name": "X-Request-Id",
              "include_in_response": true,
              "algorithm": "uuid"
            }
          }
        ]
      }
    }
  ]
}
